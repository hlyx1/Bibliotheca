name: Compile mihomo

on:
  workflow_run:
    workflows: ["Sync Ruleset"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  MIHOMO_VERSION: Prerelease-Alpha
  MIHOMO_PACKAGE_BASE: mihomo-linux-amd64
  MIHOMO_COMMIT: a001b1b

jobs:
  compile:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: ["", "-v1", "-v2", "-v3"]
    steps:
      - uses: actions/checkout@v6
      - shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"
      - shell: bash
        run: |
          python -Im pip install --upgrade pip
          python -Im pip install --requirement Ruleset/requirements.txt
      - shell: bash
        run: |
          workdir="$(mktemp -d)"
          trap 'rm -rf "$workdir"' EXIT
          variant="${{ matrix.variant }}"
          package_name="${{ env.MIHOMO_PACKAGE_BASE }}${variant}-alpha-${{ env.MIHOMO_COMMIT }}.gz"
          uri="https://github.com/MetaCubeX/mihomo/releases/download/${{ env.MIHOMO_VERSION }}/${package_name}"
          curl --fail --location --retry 5 --retry-delay 5 --retry-all-errors -o "$workdir/pkg.gz" "$uri"
          gzip -d "$workdir/pkg.gz"
          chmod +x "$workdir/pkg"
          mv "$workdir/pkg" "$workdir/mihomo"
      - shell: bash
        run: |
          python Ruleset/main.py
      - shell: bash
        run: |
          workdir="$(mktemp -d)"
          trap 'rm -rf "$workdir"' EXIT
          variant="${{ matrix.variant }}"
          package_name="${{ env.MIHOMO_PACKAGE_BASE }}${variant}-alpha-${{ env.MIHOMO_COMMIT }}.gz"
          uri="https://github.com/MetaCubeX/mihomo/releases/download/${{ env.MIHOMO_VERSION }}/${package_name}"
          curl --fail --location --retry 5 --retry-delay 5 --retry-all-errors -o "$workdir/pkg.gz" "$uri"
          gzip -d "$workdir/pkg.gz"
          chmod +x "$workdir/pkg"
          mv "$workdir/pkg" "$workdir/mihomo"

          # Compile mihomo rulesets
          for category in domain ipcidr; do
            find Ruleset/mihomo/text -name "*.${category}.txt" -type f | while read txt_file; do
              basename_file=$(basename "$txt_file" .${category}.txt)
              output_file="Ruleset/mihomo/mrs/${basename_file}.${category}.mrs"
              mkdir -p "$(dirname "$output_file")"
              "$workdir/mihomo" convert-ruleset "$category" text "$txt_file" "$output_file" || continue
            done

            find Ruleset/mihomo/yaml -name "*.${category}.yaml" -type f | while read yaml_file; do
              basename_file=$(basename "$yaml_file" .${category}.yaml)
              output_file="Ruleset/mihomo/mrs/${basename_file}.${category}.mrs"
              [ -f "$output_file" ] || {
                mkdir -p "$(dirname "$output_file")"
                "$workdir/mihomo" convert-ruleset "$category" yaml "$yaml_file" "$output_file" || continue
              }
            done
          done
      - shell: bash
        run: |
          if [[ -n "$(git status --porcelain Ruleset/mihomo/mrs)" ]]; then
            git add Ruleset/mihomo/mrs
            git commit -m "chore(mihomo): update compiled ruleset${{ matrix.variant }}"
            git push
          fi
